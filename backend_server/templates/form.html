<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Project name</title>
    <link href='{{ url_for('static',filename='styles/style.css') }}' rel='stylesheet' type="text/css">
  </head>
  <body>
    <header>
        <h1>The name of the project</h1>
        <p>Silfverberg Lab</p>

    </header>
    <article>
        <div class="form">
            <h2>Submit data</h2>
            <p>Please enter the text you wish to submit:</p>       
            <form>
                <textarea id=input_text></textarea>
                <p>Choose the model that you wish to use:</p>
                <div id="model_buttons">
                    <input type="radio" id="fairseq" 
                           name="model" value="fairseq" checked>
                    <label for="fairseq" class="model_button">fairseq</label>
                    <input type="radio" id="coling" 
                           name="model" value="coling">
                    <label for="coling" class="model_button">coling</label>
                </div>
            </form>
            <button id=button class=job_buttons onclick="button()">Submit</button>    
        </div>
    
        <div class="form">
            <h2>Get status of request</h2>
            <p>Enter job id:</p>
            <form id="input_job_id_form">
                <input type="number" id="input_job_id">
            </form>
            <button id=button_2 class=job_buttons onclick="checkStatus(document.getElementById('input_job_id').value)">
                Request job status
            </button>
            <div id="running_message" style="display:none">
                <p>Your job is running. This will automatically update, when your job is complete.</p>
            </div>
            <div id = "completed_message" style = "display:none">
                <h2>Request Results</h2>
                <!-- <textarea id="completed_job"></textarea> -->
                <div class=results_wrapper>
                    <table id="results_table">
                        <!-- here will be the results table -->
                    </table>
                </div>

                <div class="range_and_save">
                    <div id=legend>
                        <h3>Table Legend</h3>
                        <p class=input_token>Input token</p>
                        <p id=segmentation_list_legend>List of n-best segmentations</p>
                        <p> Preferred segmentation</p>
                    </div>

                    <p>Choose displayed token range:</p>
                    <div id=range_table_wrapper>
                        <table id="range_table">
                            <!-- range table will be here -->
                        </table>
                    </div>
                    <button id=submit_button class=job_buttons>Save changes</button>

                </div>

            </div>
        </div>
    </article>
    <footer>

    </footer>

    <script>
    // to get the last job id used in the browser
    document.getElementById("input_job_id").value = localStorage.getItem("last_job_id") || "";
    function getValue(data)
    {
        // this function will allow to choose the correct or new segmentation from drop down menu
        var myDiv = document.getElementById( data.id + '-value' );
        myDiv.innerHTML = data.value;
    }
    let timeout_result;

    async function checkStatus(jobId) {
        localStorage.setItem("last_job_id", String(jobId));
        // if we are waiting for a different job, we do not need to keep waiting for the previous one
        clearTimeout(timeout_result);
        // const jobId = document.getElementById("input_job_id").value;
        const status = await requestData(`/api/job/${jobId}`);
        const running_message = document.getElementById("running_message");
        const completed_message = document.getElementById("completed_message");
        // const completed_job = document.getElementById("completed_job");

        if (status.status) {
            // alert("Your job has completed.");
            running_message.style.display = "none";
            completed_message.style.display = "flex";
            // completed_job.value = "loading result";
            const result = await requestData(`/api/job/${jobId}/download`);
            const result_string = JSON.stringify(result);
            // completed_job.value = result_string;
            displayOutputRangeTable(result_string, jobId);
            displayTable(result_string, 0, 100, jobId);
            // scroll to the results
            completed_message.scrollIntoView(true);
        } else {
            // alert("The job has submitted, but not completed yet. It is running. Rest assured you will be notified when it will get processed.");
            completed_message.style.display = "none";
            running_message.style.display = "block";
            // wait 2 s and run checkStatus again
            timeout_result = setTimeout(checkStatus, 2000, jobId);
        }
    }

    function displayOutputRangeTable(json_string, jobId) {
        let range_table = document.getElementById("range_table");
        const token_list = JSON.parse(json_string);
        const token_number = token_list.length;
        const range_rows = Math.ceil(token_number/100);
        const tokens_per_view = 100;
        let current_index = 0;
        range_table.innerHTML = "";
        for (i = 0; i < range_rows; i++) {
            let row = range_table.insertRow();
            let cell = row.insertCell();
            const range_button = document.createElement("button");
            range_button.setAttribute('class', 'range_button');
            const lower_bound = i*tokens_per_view;
            const upper_bound = i != range_rows - 1? (i+1)*tokens_per_view : token_number;
            range_button.value = `${lower_bound} - ${upper_bound}`;
            range_button.innerText = range_button.value;
            cell.appendChild(range_button);
            const current_i = i;
            range_button.onclick = () => {
                displayTable(json_string, lower_bound, upper_bound, jobId);
            }
        }
        // add an onclick function 
        // add appropriate display
    }

    // assumes that token_list contains tokens startingfrom index start 
    // and ending at index end exclusive
    function displayTable(json_string, start, end, jobId) {
        // TODO add functionality to display appropriate table
        let results_table = document.getElementById("results_table");
        // convert JSON to list of JS objects
        const token_list = JSON.parse(json_string);
        const tokens_included = end - start;
        const column_number = (tokens_included >= 10) ? 10 : tokens_included;
        const row_number = Math.ceil(tokens_included/10);
        let current_index = 0;
        results_table.innerHTML = "";
        // the table will contain at most 10 columns and at most 10 rows. 
        // the outer loop will count up to ten, and break if there is less
        for (i = 0; i < row_number; i++) {
            let row = results_table.insertRow();
            for (j = 0; j < column_number; j++) {
                const current_token = current_index + start;
                if (current_token < end) {
                    let cell = row.insertCell();
                    // let text = document.createTextNode(token_list[current_token]["input"]);
                    let text = document.createElement("p");
                    text.innerText = token_list[current_token]["input"];
                    text.setAttribute('class', 'input_token');
                    let break_line = document.createElement("br");
                    cell.appendChild(text);
                    cell.appendChild(break_line);

                    // make this appear only if Custom option is selected in the drop down list.
                    let input_for_list = document.createElement("input");
                    input_for_list.setAttribute("type", "text");
                    input_for_list.minlength = 1;
                    // set as default in drop-down menu's input window to be the firstsegmentation
                    input_for_list.style.display = "none";

                    cell.appendChild(input_for_list);
   
                    // this drop down list selection is from https://stackoverflow.com/questions/17001961/how-to-add-drop-down-list-select-programmatically
                    //Create array of options to be added to the drop-down list
                    let segmentation_list = token_list[current_token]["segmentation"];


                    // Create and append select list
                    let selectList = document.createElement("select");
                    selectList.id = "segmentation";

                    // create custom select element
                    let custom_select = document.createElement("div");
                    custom_select.setAttribute('class', 'custom-select');
                    custom_select.appendChild(selectList);
                    cell.appendChild(custom_select);

                    // Create and append the options - add this when you have multiple segmentations 
                    for (var i = 0; i < segmentation_list.length; i++) {
                        let option = document.createElement("option");
                        option.value = segmentation_list[i];
                        option.text = segmentation_list[i];
                        selectList.appendChild(option);
                    }

                    let custom_option = document.createElement("option");
                    custom_option.value = "Custom"
                    custom_option.text = "Custom"
                    selectList.appendChild(custom_option);

                    // display the preferred segmentation
                    let preferredSegmentation = document.createElement("p");
                    preferredSegmentation.innerText = token_list[current_token]["preferred_segmentation"];
                    cell.appendChild(preferredSegmentation);

                    // set the preferred segmentation
                    selectList.onchange = () => {
                        const selectedOption = selectList.options[selectList.selectedIndex].value;
                        if ( selectedOption === custom_option.value) {
                            custom_select.style.display = "none";
                            input_for_list.style.display = "block";
                            // input_for_list.onchange allows for setting of preferred segmentation to 
                            // user inputs and reverts to the list view, with
                        } else {
                            token_list[current_token]["preferred_segmentation"] = selectedOption;
                        }
                        preferredSegmentation.innerText = token_list[current_token]["preferred_segmentation"];
                    }

                    input_for_list.onchange = () => {
                     // TODO add preferred_segmentation to the JSON object, the default value of which will be the first segmentation
                        token_list[current_token]["preferred_segmentation"] = input_for_list.value;
                        input_for_list.style.display = "none";
                        custom_select.style.display = "block";
                        preferredSegmentation.innerText = token_list[current_token]["preferred_segmentation"];
                    }
 
                    // let input_for_list = document.createElement("input");
                    // input_for_list.setAttribute("type", "text");
                    // // set as default in drop-down menu's input window to be the firstsegmentation
                    // const first_segmentation = segmentation_list[0];
                    // input_for_list.setAttribute("value", first_segmentation);
                    // input_for_list.setAttribute("list", "segmentationList");

                    // let segmentation_drop_down = document.createElement("datalist");
                    // segmentation_drop_down.id = "segmentationList";

                    // for (var i = 0; i < segmentation_list.length; i++) {
                    //     let option = document.createElement("option");
                    //     option.value = segmentation_list[i];
                    //     option.text = segmentation_list[i];
                    //     segmentation_drop_down.appendChild(option);
                    // }

                    // cell.appendChild(input_for_list);
                    // cell.appendChild(segmentation_drop_down);

                    current_index++;
                } else {
                    break;
                }

            }
        }


        const submit_button = document.getElementById("submit_button");
        submit_button.id = "save_button";
        // const table_div = document.getElementById("completed_message");
        // table_div.appendChild(submit_button);

        submit_button.onclick = async () => {
            const saveRequestResult = await requestData(`/api/job/${jobId}/save`, token_list, 'POST');
            alert("you save was successful");
        }
    }

    async function button() {
        const inputText = document.getElementById("input_text").value;
        const isFairseq = document.getElementById("fairseq").checked;
        const isColing = document.getElementById("coling").checked;
        let data;
        if (isFairseq) {
            data = {text:inputText, model:'fairseq'};
        } else {
            data = {text:inputText, model:'coling'};
        }
        const jobData = await requestData('/api/job', data, 'POST');
        document.getElementById("input_job_id").value = jobData.job_id;
    }

    async function requestData(url = '', data = {}, method = 'GET') {
        // Default options are marked with *
        let response;
        try {
            response = await fetch(url, {
                method: method, // *GET, POST, PUT, DELETE, etc.
                credentials: 'include', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'application/json'
                },
                body: method==='POST'? JSON.stringify(data) : undefined, // body data type must match "Content-Type" header
            });
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
        } catch(err) {
            alert("Could not submit a request")
            throw err;
        }
        const job_data = await response.json();
        return job_data;
    }
    </script>
  </body>
</html>